<!--
 * @Author: your name
 * @Date: 2020-03-20 15:04:03
 * @LastEditTime: 2020-03-20 18:55:02
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: /backend-series/redis/数据同步.md
 -->

 ### 数据同步

 #### CAP定理
 - Consistent 一致性
 - Availability 可用性
 - Partition Tolerance 分区容忍性

当Redis多台机器分布在不同的网络中，Redis选择了可用性，或者说Redis选择了另外一种最终一致性，也就是不保证主从数据在任何时刻都是一致的，并且Redis主从同步默认是异步的。

#### 主从复制
在需要**扩展读请求**的时候，或者在需要写入临时数据的时候，用户可以通过设置额外的Redis从服务器来保存数据集的副本。在接收到主服务器发送的数据初始副本之后，客户端每次向主服务器进行写入时，从服务器都会实时地得到更新。在部署好主从服务器之后，客户端就可以向任意一个从服务器发送读请求了，而不必再像之前一样，总是把每个读请求都发送给主服务器。

##### 全量复制
Redis的全量复制过程：

![](/redis/assets/redis主从同步.png)

考虑一个多从并发全量复制问题：

如果此时有多个从结点同时向主结点发起全量同步请求会怎样？

比如现在有3个从结点A/B/C陆续向主节点发起SYNC全量同步请求。
- 主节点在对A进行bgsave的同时，B和C的SYNC命令到来了，那么主节点就一锅烩，把针对A的快照数据和缓冲区数据同时同步给ABC，这样提高了效率又保证了正确性。
  
- 主节点对A的快照已经完成并且现在正在进行缓冲区同步，那么只能等A完成之后，再对B和C进行和A一样的操作过程，来实现新节点的全量同步，所以主节点并没有偷懒而是重复了这个过程，虽然繁琐但是保证了正确性。


##### 增量复制

增量复制过程稍微简单一些，但是非常有用，试想复杂的网络环境下，并不是每次断开都无法恢复，如果每次断开恢复后就要进行全量复制，那岂不是要把主节点搞死，所以增量复制算是对复杂网络环境下数据复制过程的一个优化，允许一段时间的落后，最终追上就行。

增量复制是个典型的生产者-消费者模型，使用定长环形数组(队列)来实现，如果buffer满了那么新数据将覆盖老数据，因此从结点在复制数据的同时向主节点反馈自己的偏移量，从而确保数据不缺失。

如果在网络断开时间过长时会出现**buffer被覆盖**，从结点消费滞后，此时只能进行全量复制了。

##### 无盘复制

所谓盘是指磁盘，可能是机械磁盘或者SSD，但是无论哪一种相比内存都更慢，我们都知道IO操作在服务端的耗时是占大头的，因此对于全量复制这种高IO耗时的操作来说，尤其当服务并发比较大且还在进行其他操作时对Redis服务本身的影响是比较大。

之前的模式是：主节点在生成快照时先将RDB存储到磁盘上，快照生成之后再将RDB文件加载进内存，再通过网络传给从节点。

在Redis2.8.18版本之后，开发了无盘复制，也就是避免了生成的RDB文件落盘再加载再网络传输的过程，而是流式的遍历发送过程，**主节点一边遍历内存数据，一边将数据序列化发送给从结点**，从结点没有变化，仍然将数据依次存储到本地磁盘，完成传输之后进行内存加载，可见无盘复制是对IO更友好。




